extends layout.pug
block content

    //- TODO: 加User資訊
    //- #user_pic
    //- #user_name
    #note_pic
    #note_name
    #note_version
    #showShareDetail.showShareDetail
    input#dateTimePicker.form-control(type='text')

    script.
        S3_HOST = 'https://goodtidy.s3.amazonaws.com/';
        elements = !{elements};
        console.log("elements:", elements);

        $('#note_name').text(elements.note_name);
        $('#note_version').text(elements.version_name);
        const note_pic_url = elements.note_pic;
        $('#note_pic').append($(`<img class="note-pic" src="${note_pic_url}"></img>`));

        note_bg = elements.file_name;
        
        let text_elements = elements.newest_version_text_elements;
        text_elements = text_elements_arr($('#showShareDetail'),text_elements);
        const Img_elements = Img_draggable_arr(elements.elements);
        elements_init($('#showShareDetail'), Img_elements, text_elements)


        function Img_draggable_arr(note_Imgcontent) {
            let Img_elements = [];
            let elements = $.parseHTML(note_Imgcontent);
            let img_background = `${S3_HOST}notes/${note_bg}`;

            elements.map((s) => {
                $(s).find('img').attr('src', img_background);
                Img_elements.push(s);
            });

            return Img_elements;
        }

        function text_elements_arr(append_div, note_textContent) {
            let text_elements = [];
            note_textContent.map((s) => {
                const element = Textarea_draggable_html(
                append_div,
                s.text,
                s.width,
                s.height,
                s.textTop,
                s.textLeft
                );
                text_elements.push(element);
            });
            return text_elements;
        }

        function elements_init(append_div, Img_elements, text_elements) {
            let elements = Img_elements.concat(text_elements);
            elements.map((e) => {
                append_div.append(e);
            });
        }
        function Textarea_draggable_html(
            div_id,
            text,
            width,
            height,
            textTop,
            textLeft
        ) {
            textLeft = +textLeft.replaceAll('px', '');
            textTop = +textTop.replaceAll('px', '');

            let new_offset = { top: textTop, left: textLeft };
            let new_width = width;
            let new_height = height;
            let timestamp = Date.now();
            let textarea_id = `${timestamp}_textarea`;
            let newElement = $(
                `<div class="div_addtextarea"><textarea id="${textarea_id}" readonly>${text}</textarea></div>`
            )
            .width(new_width)
            .height(new_height)
            .css({
                'position': 'relative',
            })
            .offset(new_offset)

                return newElement;
            }